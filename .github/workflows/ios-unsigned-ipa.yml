name: iOS Unsigned IPA (for AltStore)
on: [workflow_dispatch]

jobs:
  build-unsigned-ipa:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Diagnose repo layout
        run: |
          echo "PWD:"; pwd
          echo "Top-level files:"; ls -la
          echo "Search project.yml:"
          find . -maxdepth 3 -name project.yml -print

      - name: Detect PROJECT_DIR
        id: detect
        shell: bash
        run: |
          set -e
          PDIR="$(dirname "$(find . -maxdepth 3 -name project.yml | head -n1)")"
          if [ -z "$PDIR" ]; then
            echo "❌ project.yml not found. Push the iOS project (with project.yml) to this repo."
            exit 1
          fi
          echo "PROJECT_DIR=$PDIR" >> $GITHUB_ENV
          echo "Detected PROJECT_DIR=$PDIR"

      - name: Generate Xcode project
        working-directory: ${{ env.PROJECT_DIR }}
        run: xcodegen generate

      # 스킴 이름은 project.yml 기준으로 ChatStyleKeyboard 입니다.
      - name: Build (unsigned .app)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          xcodebuild -scheme ChatStyleKeyboard \
            -project ChatStyleKeyboard.xcodeproj \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO build

      - name: Package .ipa (unsigned)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          set -e
          echo "Search built .app under ./build"
          APP_PATH=$(find ./build -name ChatStyleKeyboard.app -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Fallback: search anywhere"
            APP_PATH=$(find . -name ChatStyleKeyboard.app -type d | head -n 1)
          fi
          if [ -z "$APP_PATH" ]; then
            echo "❌ .app not found. Check previous build logs for errors."
            exit 1
          fi
          echo "Using APP_PATH=$APP_PATH"
          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r ChatStyleKeyboard-unsigned.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ChatStyleKeyboard-unsigned
          path: ${{ env.PROJECT_DIR }}/ChatStyleKeyboard-unsigned.ipa
