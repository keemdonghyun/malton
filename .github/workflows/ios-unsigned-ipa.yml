name: iOS Unsigned IPA (for AltStore)
on: [workflow_dispatch]

jobs:
  build-unsigned-ipa:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: ver1.0.2
        run: xcodegen generate

      - name: List schemes (debug)
        working-directory: ver1.0.2
        run: xcodebuild -list -project ChatStyleKeyboard.xcodeproj

      - name: Build (unsigned .app)
        working-directory: ver1.0.2
        run: |
          xcodebuild -scheme ChatStyleKeyboard \
            -project ChatStyleKeyboard.xcodeproj \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO build

      - name: Package .ipa (unsigned)
        working-directory: ver1.0.2
        run: |
          APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå .app not found"; ls -R ./build ; exit 1
          fi
          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r ChatStyleKeyboard-unsigned.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ChatStyleKeyboard-unsigned
          path: ver1.0.2/ChatStyleKeyboard-unsigned.ipa
