name: iOS Unsigned IPA (for AltStore)
on: [workflow_dispatch]

jobs:
  build-unsigned-ipa:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Diagnose repo layout
        run: |
          echo "PWD:"; pwd
          echo "Top-level files:"; ls -la
          echo "Search project.yml:"; find . -maxdepth 4 -name project.yml -print

      - name: Detect PROJECT_DIR
        id: detect
        shell: bash
        run: |
          set -e
          PDIR="$(dirname "$(find . -maxdepth 4 -name project.yml | head -n1)")"
          if [ -z "$PDIR" ]; then
            echo "❌ project.yml not found."; exit 1
          fi
          echo "PROJECT_DIR=$PDIR" >> $GITHUB_ENV
          echo "Detected PROJECT_DIR=$PDIR"

      - name: Generate Xcode project
        working-directory: ${{ env.PROJECT_DIR }}
        run: xcodegen generate

      - name: List schemes
        id: lists
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          xcodebuild -list -project ChatStyleKeyboard.xcodeproj
          # 첫 번째 스킴 자동 추출
          SCHEME=$(xcodebuild -list -project ChatStyleKeyboard.xcodeproj | awk '/Schemes:/{flag=1;next}/^[^ \t]/{flag=0}flag' | head -n1 | xargs)
          if [ -z "$SCHEME" ]; then SCHEME="ChatStyleKeyboard"; fi
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV
          echo "Detected SCHEME=$SCHEME"

      - name: Build (unsigned .app)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          set -e
          echo "Building scheme=$SCHEME"
          xcodebuild -scheme "$SCHEME" \
            -project ChatStyleKeyboard.xcodeproj \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO build | tee build.log
          echo "--- Build tail ---"; tail -n 100 build.log

      - name: Package .ipa (unsigned)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          set -e
          APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "❌ .app not found."; ls -R ./build ; exit 1
          fi
          echo "Using APP_PATH=$APP_PATH"
          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r ChatStyleKeyboard-unsigned.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ChatStyleKeyboard-unsigned
          path: ${{ env.PROJECT_DIR }}/ChatStyleKeyboard-unsigned.ipa
